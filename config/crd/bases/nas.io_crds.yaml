apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: zpools.nas.io
spec:
  group: nas.io
  names:
    kind: ZPool
    listKind: ZPoolList
    plural: zpools
    singular: zpool
  scope: Namespaced
  versions:
    - name: v1alpha1
      served: true
      storage: true
      schema:
        openAPIV3Schema:
          type: object
          properties:
            spec:
              type: object
              required: [nodeName, poolName, vdevs]
              properties:
                nodeName: {type: string}
                poolName: {type: string}
                vdevs:
                  type: array
                  items:
                    type: object
                    required: [type, devices]
                    properties:
                      type: {type: string}
                      devices:
                        type: array
                        items: {type: string}
            status:
              type: object
              properties:
                appliedHash: {type: string}
                observedGeneration: {type: integer, format: int64}
                phase: {type: string}
                message: {type: string}
                usage:
                  type: object
                  properties:
                    total: {type: integer, format: int64}
                    used: {type: integer, format: int64}
                    available: {type: integer, format: int64}
                conditions:
                  type: array
                  items:
                    type: object
                    properties:
                      type: {type: string}
                      status: {type: string}
                      reason: {type: string}
                      message: {type: string}
                      lastTransitionTime: {type: string}
      subresources:
        status: {}
---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: zdatasets.nas.io
spec:
  group: nas.io
  names:
    kind: ZDataset
    listKind: ZDatasetList
    plural: zdatasets
    singular: zdataset
  scope: Namespaced
  versions:
    - name: v1alpha1
      served: true
      storage: true
      schema:
        openAPIV3Schema:
          type: object
          properties:
            spec:
              type: object
              required: [nodeName, datasetName, properties]
              properties:
                nodeName: {type: string}
                datasetName: {type: string}
                properties:
                  type: object
                  additionalProperties:
                    type: string
            status:
              type: object
              properties:
                phase: {type: string}
                message: {type: string}
      subresources:
        status: {}
---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: nasdirectories.nas.io
spec:
  group: nas.io
  names:
    kind: NASDirectory
    listKind: NASDirectoryList
    plural: nasdirectories
    singular: nasdirectory
  scope: Namespaced
  versions:
    - name: v1alpha1
      served: true
      storage: true
      schema:
        openAPIV3Schema:
          type: object
          properties:
            spec:
              type: object
              properties:
                type: {type: string}
                servers:
                  type: array
                  items: {type: string}
                baseDN: {type: string}
                realm: {type: string}
                workgroup: {type: string}
                bind:
                  type: object
                  properties:
                    username: {type: string}
                    secretRef:
                      type: object
                      required: [name]
                      properties:
                        name: {type: string}
                tls:
                  type: object
                  properties:
                    caBundleSecretRef:
                      type: object
                      required: [name]
                      properties:
                        name: {type: string}
                    verify: {type: boolean}
                idMapping:
                  type: object
                  properties:
                    strategy: {type: string}
                    uidAttribute: {type: string}
                    gidAttribute: {type: string}
                    uidStart: {type: integer}
                    gidStart: {type: integer}
                groupResolution:
                  type: object
                  properties:
                    nestedGroups: {type: boolean}
                local:
                  type: object
                  properties:
                    uidStart: {type: integer}
                    gidStart: {type: integer}
                    strategy: {type: string}
            status:
              type: object
              properties:
                phase: {type: string}
                message: {type: string}
      subresources:
        status: {}
---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: nasusers.nas.io
spec:
  group: nas.io
  names:
    kind: NASUser
    listKind: NASUserList
    plural: nasusers
    singular: nasuser
  scope: Namespaced
  versions:
    - name: v1alpha1
      served: true
      storage: true
      schema:
        openAPIV3Schema:
          type: object
          properties:
            spec:
              type: object
              required: [username, passwordSecretRef]
              properties:
                username: {type: string}
                directoryRef: {type: string}
                uid: {type: integer}
                primaryGroup: {type: string}
                passwordSecretRef:
                  type: object
                  required: [name]
                  properties:
                    name: {type: string}
            status:
              type: object
              properties:
                phase: {type: string}
                message: {type: string}
      subresources:
        status: {}
---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: nasgroups.nas.io
spec:
  group: nas.io
  names:
    kind: NASGroup
    listKind: NASGroupList
    plural: nasgroups
    singular: nasgroup
  scope: Namespaced
  versions:
    - name: v1alpha1
      served: true
      storage: true
      schema:
        openAPIV3Schema:
          type: object
          properties:
            spec:
              type: object
              properties:
                directoryRef: {type: string}
                gid: {type: integer}
                members:
                  type: array
                  items: {type: string}
            status:
              type: object
              properties:
                phase: {type: string}
                message: {type: string}
      subresources:
        status: {}
---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: nasshares.nas.io
spec:
  group: nas.io
  names:
    kind: NASShare
    listKind: NASShareList
    plural: nasshares
    singular: nasshare
  scope: Namespaced
  versions:
    - name: v1alpha1
      served: true
      storage: true
      schema:
        openAPIV3Schema:
          type: object
          properties:
            spec:
              type: object
              required: [protocol, mountPath, shareName]
              properties:
                protocol: {type: string}
                datasetName: {type: string}
                pvcName: {type: string}
                mountPath: {type: string}
                shareName: {type: string}
                directoryRef: {type: string}
                readOnly: {type: boolean}
                serviceType: {type: string}
                nodePort: {type: integer}
                permissions:
                  type: object
                  properties:
                    allow:
                      type: object
                      properties:
                        users:
                          type: array
                          items: {type: string}
                        groups:
                          type: array
                          items: {type: string}
                    readOnly:
                      type: object
                      properties:
                        users:
                          type: array
                          items: {type: string}
                        groups:
                          type: array
                          items: {type: string}
                options:
                  type: object
                  x-kubernetes-preserve-unknown-fields: true
                nfs:
                  type: object
                  properties:
                    clients:
                      type: array
                      items: {type: string}
                    options: {type: string}
            status:
              type: object
              properties:
                phase: {type: string}
                message: {type: string}
                endpoint: {type: string}
      subresources:
        status: {}
---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: zsnapshots.nas.io
spec:
  group: nas.io
  names:
    kind: ZSnapshot
    listKind: ZSnapshotList
    plural: zsnapshots
    singular: zsnapshot
  scope: Namespaced
  versions:
    - name: v1alpha1
      served: true
      storage: true
      schema:
        openAPIV3Schema:
          type: object
          properties:
            spec:
              type: object
              required: [pvcName]
              properties:
                pvcName: {type: string}
                snapshotClassName: {type: string}
            status:
              type: object
              properties:
                phase: {type: string}
                message: {type: string}
                volumeSnapshotName: {type: string}
      subresources:
        status: {}
---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: zsnapshotschedules.nas.io
spec:
  group: nas.io
  names:
    kind: ZSnapshotSchedule
    listKind: ZSnapshotScheduleList
    plural: zsnapshotschedules
    singular: zsnapshotschedule
  scope: Namespaced
  versions:
    - name: v1alpha1
      served: true
      storage: true
      schema:
        openAPIV3Schema:
          type: object
          properties:
            spec:
              type: object
              required: [nodeName, datasetName, schedule]
              properties:
                nodeName: {type: string}
                datasetName: {type: string}
                recursive: {type: boolean}
                schedule: {type: string}
                namePrefix: {type: string}
                format: {type: string}
                retention:
                  type: object
                  properties:
                    keepLast: {type: integer}
                    keepHourly: {type: integer}
                    keepDaily: {type: integer}
                    keepWeekly: {type: integer}
                    keepMonthly: {type: integer}
            status:
              type: object
              properties:
                lastSnapshotName: {type: string}
                lastRunTime: {type: string}
                nextRunTime: {type: string}
                message: {type: string}
      subresources:
        status: {}
---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: zsnapshotrestores.nas.io
spec:
  group: nas.io
  names:
    kind: ZSnapshotRestore
    listKind: ZSnapshotRestoreList
    plural: zsnapshotrestores
    singular: zsnapshotrestore
  scope: Namespaced
  versions:
    - name: v1alpha1
      served: true
      storage: true
      schema:
        openAPIV3Schema:
          type: object
          properties:
            spec:
              type: object
              required: [mode]
              properties:
                # mode: "clone" (ZFS dataset clone via node-agent) OR "csi" (PVC restore from VolumeSnapshot)
                mode: {type: string}

                # clone mode
                nodeName: {type: string}
                sourceSnapshot: {type: string}
                targetDataset: {type: string}
                forceRollback: {type: boolean}
                confirmationToken: {type: string}

                # csi mode
                sourceVolumeSnapshot: {type: string}
                targetPVC: {type: string}
                storageClassName: {type: string}
                accessModes:
                  type: array
                  items: {type: string}
                resources:
                  type: object
                  x-kubernetes-preserve-unknown-fields: true
            status:
              type: object
              properties:
                phase: {type: string}
                message: {type: string}
                resultDataset: {type: string}
                resultPVC: {type: string}
      subresources:
        status: {}
